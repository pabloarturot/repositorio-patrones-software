package reciver;

import java.io.IOException;
import java.io.ObjectInputStream;
import java.net.ServerSocket;
import java.net.Socket;

import base.Message;

import controller.ControllerListener;

public class TCPReceiver implements Receiver {

	private boolean isAlive = true;
    private final ServerSocket serverSocket;
    private final ControllerListener controllerListener;

    public TCPReceiver(final ControllerListener controllerListener) throws IOException {
        serverSocket = new ServerSocket(8899);
        this.controllerListener = controllerListener;
    }

    @Override
    public void receive() {
        while (isAlive) {
            try {
                final Socket cliente = serverSocket.accept();
                final Thread thread = new Thread(new ClienteSocket(cliente));
                thread.start();
            } catch (final IOException ex) {
                System.out.println(ex);
            }
        }
    }

    @Override
    public void finalizar() {
        isAlive = false;
        try {
            serverSocket.close();
        } catch (final IOException ex) {
            System.out.println(ex);
        }
    }

    private class ClienteSocket implements Runnable {

        private final Socket cliente;

        public ClienteSocket(final Socket cliente) {
            this.cliente = cliente;
        }

        @Override
        public void run() {
            try {
                final ObjectInputStream ois = new ObjectInputStream(cliente.getInputStream());
                final Message mensaje = (Message) ois.readObject();
                controllerListener.notifyTCPMsg(mensaje);

                cliente.shutdownInput();
                cliente.shutdownOutput();

                ois.close();
                cliente.getOutputStream().close();
                cliente.close();
            } catch (final IOException ex) {
                System.out.println(ex);
            } catch (final ClassNotFoundException ex) {
                System.out.println(ex);
            }
        }
    }
}
