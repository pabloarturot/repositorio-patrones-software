package com.greenhouse.sim;

import java.util.List;

import com.greenhouse.base.Message;
import com.greenhouse.controller.ContextComControllerImpl;
import com.greenhouse.controller.ContextCommunicationController;

public class TemperatureController {
	
	 	private ContextConsultaTemperatura consultor;
	    private ContextEnvioInfoTemperatura informante;
	    private ContextCommunicationController context;
	    private int frequencyInterval;

	    public TemperatureController(){

	        frequencyInterval=5;
	        context=new ContextComControllerImpl();
	        context.startMeeting();
	        
	        consultor=new ContextConsultaTemperatura(context);
	        informante=new ContextEnvioInfoTemperatura(context);
	    }


	     public List<Message> getTerminalsTemperatures() {

	         List<Message> temperatures=consultor.obtenerLecturasTerminales();
	         obtenerFrecuenciaPreferida(temperatures);

	         return temperatures;
	     }

	     public Message getLocalTemperature(){

	    	 Message dto = informante.obtenerLecturaLocal();
	         informante.enviarInformacion(dto,frequencyInterval);
	         return dto;
	     }

	    
	    public int getFrequencyInterval() {
	        return frequencyInterval;
	    }
	   
	    public void setFrequencyInterval(int frecuencaSecParam) {

	        if(frecuencaSecParam>0){
	           frequencyInterval = frecuencaSecParam;           
	        }
	    }

	    private void obtenerFrecuenciaPreferida(List<Message> temperaturas){
	        
	        long timeStamp=0;

	        for(Message dto : temperaturas){

	            long timeStampTemporal=dto.getTimestamp();

	             if(timeStampTemporal>timeStamp){
	                 timeStamp=timeStampTemporal;
	                 setFrequencyInterval(dto.getFrequency());
	             }
	         }
	    }

	    public void cerrarConexionesTerminalesRemotas(){
	        context.endMeeting();
	    }

}
