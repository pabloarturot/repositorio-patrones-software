package com.greenhouse.sim;

import java.util.List;

import com.greenhouse.base.Message;
import com.greenhouse.controller.ContextComControllerImpl;
import com.greenhouse.controller.ContextCommunicationController;

public class TemperatureController {
	
	 	private ContextConsultaTemperatura consultor;
	    private localTemperatureInformer localInformer;
	    private ContextCommunicationController context;
	    private int frequencyInterval;

	    public TemperatureController(){

	        frequencyInterval=5;
	        context=new ContextComControllerImpl();
	        context.startMeeting();
	        
	        consultor=new ContextConsultaTemperatura(context);
	        localInformer=new localTemperatureInformer(context);
	    }


	     public List<Message> getTerminalsTemperatures() {

	         List<Message> temperatures=consultor.obtenerLecturasTerminales();
	         getPreferredFrequency(temperatures);

	         return temperatures;
	     }

	     public Message getLocalTemperature(){

	    	 Message dto = localInformer.obtenerLecturaLocal();
	         localInformer.enviarInformacion(dto,frequencyInterval);
	         return dto;
	     }

	    
	    public int getFrequencyInterval() {
	        return frequencyInterval;
	    }
	   
	    public void setFrequencyInterval(int param) {

	        if(param>0){
	           frequencyInterval = param;           
	        }
	    }

	    private void getPreferredFrequency(List<Message> temperatures){
	        
	        long timeStamp=0;

	        for(Message dto : temperatures){

	            long temp=dto.getTimestamp();

	             if(temp>timeStamp){
	                 timeStamp=temp;
	                 setFrequencyInterval(dto.getFrequency());
	             }
	         }
	    }

	    public void closeTerminalsConn(){
	        context.endMeeting();
	    }

}
