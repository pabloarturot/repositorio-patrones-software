package controller;

import java.io.IOException;
import java.util.Date;
import java.util.HashMap;
import java.util.Map;

import reciver.Receiver;
import reciver.TCPReceiver;
import reciver.UDPReceiver;

import forwarder.Forwarder;
import forwarder.TCPForwarder;
import forwarder.UDPForwarder;

import util.NetworkUtil;

import base.Message;
import base.MessageImpl;

public class ContextComControllerImpl implements ContextCommunicationController, ControllerListener {
	
	private final Map<String, String> ipTables = new HashMap<String, String>();
    private final Map<String, Message> messages = new HashMap<String, Message>();
    private Forwarder forwarderTCP;
    private Forwarder forwarderUDP;
    private Receiver receiverTCP;
    private Receiver receiverUDP;
    private String hostIp;
    private String hostname;

    public ContextComControllerImpl() {
        try {
            hostname = NetworkUtil.obtenerNombre();
            if (hostname.length() > 50) {
                hostname.substring(0, 51);
            }

            hostIp = NetworkUtil.obtenerIP();

            forwarderTCP = new TCPForwarder();
            forwarderUDP = new UDPForwarder();
            receiverTCP = new TCPReceiver(this);
            receiverUDP = new UDPReceiver(this);

            initTCPListener();
            initUPDListener();
        } catch (final IOException ex) {
            System.err.println(ex);
            System.exit(-1);
        }
    }
 

    
    private void initTCPListener() {
        final Thread tcpListener = new Thread(new Runnable() {

            @Override
            public void run() {
                receiverTCP.recibir();
            }
        });
        tcpListener.start();
    }

    private void initUPDListener() {
        final Thread udpListener = new Thread(new Runnable() {

            @Override
            public void run() {
                receiverUDP.recibir();
            }
        });
        udpListener.start();
    }
  
    @Override
    public void startMeeting() {
        try {
            final Message Message = new MessageImpl(
                    hostIp,
                    hostname,
                    0,
                    new Date().getTime(),
                    0);
            forwarderUDP.enviar(Message);
        } catch (final IOException ex) {
            System.out.println(ex);
        }
    }

    @Override
    public void sendMessage(final Message message) {
    	final Message send = new MessageImpl(
    			hostIp,
    			hostname,
    			message.getTemperature(),
    			new Date().getTime(),
    			message.getFrequency());
    	try {
    		forwarderTCP.enviar(send);
    	} catch (final IOException ex) {
    		System.out.println(ex);
    	}
    }
    
    @Override
    public Map<String, Message> receiveMessages() {
    	final Map<String, Message> mapRetorno = new HashMap<String, Message>();
    	mapRetorno.putAll(messages);
    	messages.clear();
    	return mapRetorno;
    }
    
    @Override
    public void endMeeting() {
        receiverTCP.finalizar();
        receiverUDP.finalizar();
    }

  
	@Override
	public void notificarMensajeUDP(final Message message) {
		ipTables.put(message.getHostIp(), message.getAlias());
		
	}
	
	@Override
	public void notificarMensajeTCP(final Message message) {
		messages.put(message.getHostIp(), message);
		
	}

}
